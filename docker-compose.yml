version: '3.9'

networks:
  backend:
    driver: bridge

services:
  # =========================
  # MySQL for Orders + Shipments
  # =========================
  mysql_db:
    image: mysql:8.0
    container_name: mysql_db
    environment:
      MYSQL_ROOT_PASSWORD: yourpassword
      MYSQL_DATABASE: order_db
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -pyourpassword || exit 1"]
      interval: 10s
      retries: 5
      timeout: 5s
    networks:
      - backend

  # =========================
  # Postgres Main (all DBs in one container)
  # =========================
  postgres_main:
    image: postgres:16-alpine
    container_name: postgres_main
    restart: always
    environment:
      POSTGRES_USER: poojasrinivasan
      POSTGRES_PASSWORD: password
      POSTGRES_DB: catalog_db
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U poojasrinivasan -d catalog_db && psql -U poojasrinivasan -d payment_db -c 'SELECT 1;' > /dev/null 2>&1"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 30s
    networks:
      - backend

  # =========================
  # Services
  # =========================
  catalogservice:
    build:
      context: ./catalog-service
      dockerfile: Dockerfile
    container_name: catalogservice
    ports:
      - "3000:3000"
    depends_on:
      postgres_main:
        condition: service_healthy
    environment:
      DB_HOST: postgres_main
      DB_PORT: 5432
      DB_USER: poojasrinivasan
      DB_PASSWORD: password
      DB_NAME: catalog_db
    volumes:
      - ./catalog-service/config:/app/config
    networks:
      - backend

  customerservice:
    build:
      context: ./customerservice
      dockerfile: Dockerfile
    container_name: customerservice
    ports:
      - "3001:3000"
    depends_on:
      postgres_main:
        condition: service_healthy
    environment:
      DB_HOST: postgres_main
      DB_PORT: 5432
      DB_USER: poojasrinivasan
      DB_PASSWORD: password
      DB_NAME: customer_db
    volumes:
      - ./customerservice/config:/app/config
    networks:
      - backend

  inventoryservice:
    build:
      context: ./inventoryservice
      dockerfile: Dockerfile
    container_name: inventoryservice
    ports:
      - "3002:3000"
    depends_on:
      postgres_main:
        condition: service_healthy
    environment:
      DB_HOST: postgres_main
      DB_PORT: 5432
      DB_USER: poojasrinivasan
      DB_PASSWORD: password
      DB_NAME: inventory_db
    volumes:
      - ./inventoryservice/config:/app/config
    networks:
      - backend

  order_service:
    build:
      context: ./Scalable_Services_Assignment_Orders_Services_PS4
      dockerfile: Dockerfile
    container_name: order_service
    ports:
      - "8000:8000"
    depends_on:
      mysql_db:
        condition: service_healthy
    environment:
      DB_HOST: mysql_db
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: yourpassword
      DB_NAME: order_db
    networks:
      - backend

  shipment_service:
    build:
      context: ./Scalable_Services_Assignment_Shipment_Services_PS4
      dockerfile: Dockerfile
    container_name: shipment_service
    ports:
      - "8001:8001"
    depends_on:
      mysql_db:
        condition: service_healthy
    environment:
      DB_HOST: mysql_db
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: yourpassword
      DB_NAME: order_db
    networks:
      - backend

  payment_service:
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    container_name: payment_service
    ports:
      - "8002:8002"
    depends_on:
      postgres_main:
        condition: service_healthy
    environment:
      DB_HOST: postgres_main
      DB_PORT: 5432
      DB_USER: poojasrinivasan
      DB_PASSWORD: password
      DB_NAME: payment_db
    volumes:
      - ./payment-service/config:/app/config
    networks:
      - backend

  notification_service:
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    container_name: notification_service
    ports:
      - "8080:8080"
    depends_on:
      postgres_main:
        condition: service_healthy
    environment:
      DB_HOST: postgres_main
      DB_PORT: 5432
      DB_NAME: notifications
      DB_USER: poojasrinivasan
      DB_PASSWORD: password
    networks:
      - backend

volumes:
  mysql_data:
  pg_data: